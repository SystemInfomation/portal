<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forsyth Games | About:Blank Proxy</title>
  <link rel="icon" type="image/x-icon" href="favicon.png?login.live.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Protection module -->
  <script src="../../protection.js?v=1"></script>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f7f8fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --accent: #2563eb;
      --accent-strong: #1d4ed8;
      --radius-lg: 18px;
      --radius: 12px;
      --shadow: 0 22px 60px rgba(15, 23, 42, 0.12);
      --success: #10b981;
      --warning: #f59e0b;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1224;
        --card: #0f172a;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --border: #1f2937;
        --accent: #60a5fa;
        --accent-strong: #3b82f6;
        --shadow: 0 28px 70px rgba(0, 0, 0, 0.55);
        --success: #34d399;
        --warning: #fbbf24;
      }
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3.5rem 1rem;
      background:
        radial-gradient(circle at 20% 20%, rgba(96, 165, 250, 0.14), transparent 32%),
        radial-gradient(circle at 80% 0%, rgba(99, 102, 241, 0.12), transparent 36%),
        var(--bg);
      color: var(--text);
    }

    .card {
      width: min(600px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: clamp(1.75rem, 3vw, 2.5rem);
      display: grid;
      gap: 1.25rem;
    }

    header {
      display: grid;
      gap: 0.35rem;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.8rem, 3vw, 2.2rem);
      letter-spacing: -0.02em;
      font-weight: 700;
    }

    p.lede {
      margin: 0;
      color: var(--muted);
      font-weight: 500;
      line-height: 1.45;
    }

    .callout {
      background: color-mix(in srgb, var(--accent) 10%, var(--card));
      border: 1px solid color-mix(in srgb, var(--accent) 25%, var(--border));
      color: var(--text);
      border-radius: var(--radius);
      padding: 0.9rem 1rem;
      line-height: 1.5;
      display: grid;
      gap: 0.35rem;
    }
    .callout strong { color: var(--accent-strong); }
    .callout code {
      font-family: "Source Code Pro", ui-monospace, SFMono-Regular, Menlo, monospace;
      background: color-mix(in srgb, var(--accent) 14%, transparent);
      padding: 0.1rem 0.4rem;
      border-radius: 8px;
      font-size: 0.95rem;
    }

    label {
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .badge {
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent-strong);
      border: 1px solid rgba(37, 99, 235, 0.18);
      border-radius: 999px;
      padding: 0.15rem 0.65rem;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }
    
    .badge-proxy {
      background: rgba(16, 185, 129, 0.12);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.18);
    }

    .field {
      display: grid;
      gap: 0.5rem;
    }

    input[type="text"] {
      width: 100%;
      padding: 0.95rem 1.05rem;
      font-size: 1rem;
      border-radius: var(--radius);
      border: 1.6px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, var(--bg));
      color: var(--text);
      transition: border-color 160ms ease, box-shadow 160ms ease, background 160ms ease;
      outline: none;
    }
    input[type="text"]::placeholder {
      color: var(--muted);
      font-style: italic;
    }
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 45%, transparent);
      background: var(--card);
    }

    .mode-toggle {
      display: flex;
      gap: 0.5rem;
      background: color-mix(in srgb, var(--border) 50%, var(--card));
      padding: 0.35rem;
      border-radius: var(--radius);
    }

    .mode-btn {
      flex: 1;
      padding: 0.6rem 1rem;
      border: none;
      border-radius: calc(var(--radius) - 4px);
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 160ms ease;
    }

    .mode-btn.active {
      background: var(--card);
      color: var(--text);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .mode-btn:hover:not(.active) {
      color: var(--text);
    }

    .actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: var(--radius);
      padding: 0.9rem 1.4rem;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 160ms ease, background 160ms ease, color 160ms ease, border-color 160ms ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #fff;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.35);
      flex: 1 1 200px;
      justify-content: center;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 16px 36px rgba(37, 99, 235, 0.45); }
    .btn-primary:active { transform: translateY(0); box-shadow: 0 10px 22px rgba(37, 99, 235, 0.35); }
    
    .btn-primary.proxy-mode {
      background: linear-gradient(135deg, var(--success), #059669);
      box-shadow: 0 12px 30px rgba(16, 185, 129, 0.35);
    }
    .btn-primary.proxy-mode:hover { box-shadow: 0 16px 36px rgba(16, 185, 129, 0.45); }

    .btn-ghost {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      flex: 1 1 140px;
      justify-content: center;
    }
    .btn-ghost:hover {
      background: color-mix(in srgb, var(--accent) 10%, transparent);
      border-color: color-mix(in srgb, var(--accent) 25%, var(--border));
    }

    .meta {
      color: var(--muted);
      font-size: 0.95rem;
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .kbd {
      font-family: "Source Code Pro", ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 0.95rem;
      padding: 0.15rem 0.45rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 80%, var(--bg));
      color: var(--text);
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    .status::before {
      content: "";
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 6px color-mix(in srgb, var(--accent) 22%, transparent);
    }
    
    .status.proxy::before {
      background: var(--success);
      box-shadow: 0 0 0 6px color-mix(in srgb, var(--success) 22%, transparent);
    }

    @media (max-width: 520px) {
      body { padding: 2.25rem 1rem; }
      .card { padding: 1.5rem; }
      .actions { flex-direction: column; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <main class="card" role="main" aria-label="About:Blank Proxy">
    <header>
      <h1>About:Blank Proxy</h1>
    </header>

    <div class="callout" aria-live="polite" id="callout-info">
      <div id="mode-description">
        Enter a search query or URL to open it in a new <code>about:blank</code> tab with <strong>proxy</strong> support.<br><br>
        â€¢ <strong>Proxy Mode</strong>: Routes content through a CORS proxy. Links work within the proxy!<br>
        â€¢ <strong>Simple Mode</strong>: Opens in iframe (some sites may block this).<br><br>
        â€¢ Your actions will <strong>not</strong> be saved in your search history.<br>
        â€¢ All navigation stays within the <code>about:blank</code> tab.
      </div>
    </div>

    <section class="field">
      <label>Mode</label>
      <div class="mode-toggle">
        <button type="button" class="mode-btn active" id="mode-proxy" onclick="setMode('proxy')">ðŸ”’ Proxy</button>
        <button type="button" class="mode-btn" id="mode-simple" onclick="setMode('simple')">ðŸ“„ Simple</button>
      </div>
    </section>

    <section class="field">
      <label for="search-bar-input">
        Destination or search query
        <span class="badge badge-proxy" id="mode-badge">PROXY</span>
      </label>
      <input
        id="search-bar-input"
        type="text"
        placeholder="Paste an https:// URL or type a search query"
        aria-label="Search or URL input"
        autocomplete="off"
      />
    </section>

    <div class="actions">
      <button id="submit" class="btn-primary proxy-mode" type="button" onclick="openAboutBlank()">Open with Proxy</button>
      <button class="btn-ghost" type="button" onclick="clearInput()">Clear</button>
    </div>

    <div class="meta">
      <span class="status proxy" id="status">Proxy Ready</span>
      <span>Tip: <span class="kbd">Enter</span> to open</span>
    </div>
  </main>

  <script>
    const input = document.getElementById("search-bar-input");
    const statusEl = document.getElementById("status");
    const submitBtn = document.getElementById("submit");
    const modeBadge = document.getElementById("mode-badge");
    const modeProxyBtn = document.getElementById("mode-proxy");
    const modeSimpleBtn = document.getElementById("mode-simple");
    
    let currentMode = "proxy"; // "proxy" or "simple"
    
    // Get the origin for reference
    const ORIGIN = window.location.origin;
    
    // CORS proxy URLs (multiple fallbacks for reliability)
    // These are public CORS proxy services that allow cross-origin requests
    const CORS_PROXIES = [
      "https://api.allorigins.win/raw?url=",
      "https://corsproxy.io/?",
      "https://api.codetabs.com/v1/proxy?quest="
    ];
    
    let currentProxyIndex = 0;

    function setStatus(text, isProxy = currentMode === "proxy") {
      statusEl.textContent = text;
      statusEl.className = isProxy ? "status proxy" : "status";
    }
    
    function setMode(mode) {
      currentMode = mode;
      
      if (mode === "proxy") {
        modeProxyBtn.classList.add("active");
        modeSimpleBtn.classList.remove("active");
        submitBtn.textContent = "Open with Proxy";
        submitBtn.classList.add("proxy-mode");
        modeBadge.textContent = "PROXY";
        modeBadge.className = "badge badge-proxy";
        setStatus("Proxy Ready", true);
      } else {
        modeSimpleBtn.classList.add("active");
        modeProxyBtn.classList.remove("active");
        submitBtn.textContent = "Open in about:blank";
        submitBtn.classList.remove("proxy-mode");
        modeBadge.textContent = "SIMPLE";
        modeBadge.className = "badge";
        setStatus("Ready", false);
      }
    }

    function googleSearchURL(search) {
      search = search.trim().split(/\s+/).map(encodeURIComponent).join("+");
      return "https://www.google.com/search?q=" + search + "&igu=1";
    }

    function isURLWithProtocol(string) {
      try { new URL(string); return true; } catch { return false; }
    }

    function getURL(searchBarInput) {
      let url, isURL = true;

      if (isURLWithProtocol(searchBarInput)) {
        url = new URL(searchBarInput);
        if (url.protocol !== "http:" && url.protocol !== "https:") isURL = false;
      } else {
        isURL = false;
      }

      if (isURL) {
        if (url.protocol === "http:") {
          try { url = new URL(searchBarInput.replace("http", "https")); } catch {}
        }
        url = url.toString();
      } else {
        url = googleSearchURL(searchBarInput);
      }

      return url;
    }

    function getBaseUrl(url) {
      try {
        const parsed = new URL(url);
        return parsed.origin;
      } catch {
        return "";
      }
    }

    // Generate the proxy page HTML that will be injected into about:blank
    function generateProxyPageHTML(proxyPrefix, initialUrl) {
      return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Proxy Browser</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0a0a0a;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .toolbar {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
    }
    .nav-btns { display: flex; gap: 6px; }
    .nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .nav-btn:hover { background: rgba(255,255,255,0.2); }
    .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .url-bar {
      flex: 1;
      display: flex;
      align-items: center;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 0 12px;
      border: 1px solid #333;
    }
    .url-bar input {
      flex: 1;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 14px;
      padding: 8px 0;
      outline: none;
    }
    .url-bar input::placeholder { color: #666; }
    .go-btn {
      background: #3b82f6;
      color: #fff;
      border: none;
      padding: 6px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: background 0.2s;
    }
    .go-btn:hover { background: #2563eb; }
    .content-frame {
      flex: 1;
      border: none;
      background: #fff;
    }
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #3b82f6);
      background-size: 200% 100%;
      animation: loading 1s ease-in-out infinite;
      display: none;
      z-index: 1000;
    }
    .loading.active { display: block; }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .error-msg {
      padding: 40px;
      text-align: center;
      color: #f87171;
    }
    .error-msg h2 { margin-bottom: 12px; }
    .error-msg p { color: #999; }
  </style>
</head>
<body>
  <div class="loading" id="loading"></div>
  <div class="toolbar">
    <div class="nav-btns">
      <button class="nav-btn" id="back-btn" title="Back" disabled>â—€</button>
      <button class="nav-btn" id="forward-btn" title="Forward" disabled>â–¶</button>
      <button class="nav-btn" id="refresh-btn" title="Refresh">â†»</button>
    </div>
    <div class="url-bar">
      <input type="text" id="url-input" placeholder="Enter URL or search..." value="">
      <button class="go-btn" id="go-btn">Go</button>
    </div>
  </div>
  <!-- Note: sandbox needs allow-same-origin for blob URLs to work. Content is isolated via blob URL. -->
  <iframe class="content-frame" id="content-frame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
  
  <script>
    const PROXY_PREFIX = ${JSON.stringify(proxyPrefix)};
    const PROXIES = ${JSON.stringify(CORS_PROXIES)};
    let proxyIndex = 0;
    
    const urlInput = document.getElementById("url-input");
    const contentFrame = document.getElementById("content-frame");
    const loadingBar = document.getElementById("loading");
    const backBtn = document.getElementById("back-btn");
    const forwardBtn = document.getElementById("forward-btn");
    const refreshBtn = document.getElementById("refresh-btn");
    const goBtn = document.getElementById("go-btn");
    
    let history = [];
    let historyIndex = -1;
    let currentUrl = "";
    
    function showLoading(show) {
      loadingBar.classList.toggle("active", show);
    }
    
    function getProxy() {
      return PROXIES[proxyIndex % PROXIES.length];
    }
    
    function resolveUrl(href, baseUrl) {
      if (!href) return "";
      if (href.startsWith("javascript:") || href.startsWith("data:") || href.startsWith("#")) return href;
      try {
        return new URL(href, baseUrl).href;
      } catch {
        return href;
      }
    }
    
    function rewriteHtml(html, baseUrl) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      
      // Add base tag for relative resources
      const base = doc.createElement("base");
      base.href = baseUrl;
      if (doc.head.firstChild) {
        doc.head.insertBefore(base, doc.head.firstChild);
      } else {
        doc.head.appendChild(base);
      }
      
      // Rewrite links to go through proxy
      doc.querySelectorAll("a[href]").forEach(a => {
        const href = a.getAttribute("href");
        if (href && !href.startsWith("javascript:") && !href.startsWith("#") && !href.startsWith("data:")) {
          const fullUrl = resolveUrl(href, baseUrl);
          if (fullUrl.startsWith("http")) {
            a.setAttribute("data-proxy-href", fullUrl);
            a.setAttribute("href", "#");
            a.onclick = function(e) {
              e.preventDefault();
              // Note: Using "*" for origin since we're in about:blank context
              window.parent.postMessage({ type: "navigate", url: fullUrl }, "*");
            };
          }
        }
      });
      
      // Rewrite form actions
      doc.querySelectorAll("form[action]").forEach(form => {
        const action = form.getAttribute("action");
        if (action) {
          const fullUrl = resolveUrl(action, baseUrl);
          if (fullUrl.startsWith("http")) {
            form.setAttribute("data-proxy-action", fullUrl);
          }
        }
      });
      
      return "<!DOCTYPE html>" + doc.documentElement.outerHTML;
    }
    
    async function loadUrl(url, addToHistory = true) {
      if (!url) return;
      
      // Normalize URL
      if (!url.startsWith("http://") && !url.startsWith("https://")) {
        if (url.includes(".") && !url.includes(" ")) {
          url = "https://" + url;
        } else {
          url = "https://www.google.com/search?q=" + encodeURIComponent(url) + "&igu=1";
        }
      }
      
      currentUrl = url;
      urlInput.value = url;
      showLoading(true);
      
      try {
        const proxyUrl = getProxy() + encodeURIComponent(url);
        const response = await fetch(proxyUrl);
        
        if (!response.ok) throw new Error("Failed to fetch");
        
        const contentType = response.headers.get("content-type") || "";
        
        if (contentType.includes("text/html")) {
          const html = await response.text();
          const rewritten = rewriteHtml(html, url);
          const blob = new Blob([rewritten], { type: "text/html" });
          const blobUrl = URL.createObjectURL(blob);
          contentFrame.src = blobUrl;
        } else {
          // For non-HTML content, try to display directly
          const blob = await response.blob();
          const blobUrl = URL.createObjectURL(blob);
          contentFrame.src = blobUrl;
        }
        
        if (addToHistory) {
          history = history.slice(0, historyIndex + 1);
          history.push(url);
          historyIndex = history.length - 1;
        }
        
        updateNavButtons();
        
      } catch (err) {
        // Try next proxy
        proxyIndex++;
        if (proxyIndex < PROXIES.length) {
          loadUrl(url, false);
          return;
        }
        
        // All proxies failed - encode URL to prevent XSS
        const safeUrl = url.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        contentFrame.srcdoc = \`
          <div style="padding: 40px; text-align: center; font-family: sans-serif; color: #333;">
            <h2 style="color: #dc2626;">Failed to load page</h2>
            <p style="color: #666; margin-top: 12px;">The proxy could not fetch this page. The site may be blocking proxy requests.</p>
            <p style="color: #888; margin-top: 8px; font-size: 14px;">URL: \${safeUrl}</p>
          </div>
        \`;
        proxyIndex = 0;
      }
      
      showLoading(false);
    }
    
    function updateNavButtons() {
      backBtn.disabled = historyIndex <= 0;
      forwardBtn.disabled = historyIndex >= history.length - 1;
    }
    
    backBtn.onclick = () => {
      if (historyIndex > 0) {
        historyIndex--;
        loadUrl(history[historyIndex], false);
      }
    };
    
    forwardBtn.onclick = () => {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        loadUrl(history[historyIndex], false);
      }
    };
    
    refreshBtn.onclick = () => {
      if (currentUrl) loadUrl(currentUrl, false);
    };
    
    goBtn.onclick = () => {
      loadUrl(urlInput.value.trim());
    };
    
    urlInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        loadUrl(urlInput.value.trim());
      }
    });
    
    // Handle navigation messages from iframe
    // Note: We accept messages from 'null' origin (blob URLs) and validate the message structure
    window.addEventListener("message", (e) => {
      // Only accept messages from our blob URL iframe (origin is 'null' for blob URLs)
      if (e.origin !== 'null' && e.origin !== 'blob:') return;
      if (e.data && e.data.type === "navigate" && typeof e.data.url === "string") {
        // Validate URL starts with http/https
        if (e.data.url.startsWith("http://") || e.data.url.startsWith("https://")) {
          loadUrl(e.data.url);
        }
      }
    });
    
    // Load initial URL
    loadUrl(${JSON.stringify(initialUrl)});
  <\/script>
</body>
</html>`;
    }

    function openAboutBlank() {
      const raw = input.value.trim();
      if (!raw) {
        setStatus("Enter a URL or search query");
        input.focus();
        return;
      }

      const url = getURL(raw);
      const win = window.open();
      if (!win) {
        setStatus("Pop-up blocked. Allow pop-ups to continue.");
        return;
      }

      if (currentMode === "proxy") {
        // Proxy mode: create a full proxy browser interface
        const proxyPrefix = CORS_PROXIES[currentProxyIndex];
        const proxyPageHTML = generateProxyPageHTML(proxyPrefix, url);
        win.document.write(proxyPageHTML);
        win.document.close();
        setStatus("Opened with Proxy", true);
      } else {
        // Simple mode: just open in iframe
        const suffix = window.atob("I2xvZ2luLmxpdmUuY29t");
        win.document.body.style.margin = "0";
        win.document.body.style.height = "100%";
        const iframe = win.document.createElement("iframe");
        iframe.style.border = "none";
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.style.margin = "0";
        iframe.src = url + suffix;
        win.document.body.appendChild(iframe);
        setStatus("Opened in about:blank", false);
      }
    }

    function clearInput() {
      input.value = "";
      input.focus();
      setStatus(currentMode === "proxy" ? "Proxy Ready" : "Cleared");
    }

    input.addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        input.blur();
        openAboutBlank();
      }
    });

    input.addEventListener("input", () => setStatus(currentMode === "proxy" ? "Proxy Ready" : "Ready"));
  </script>
</body>
</html>
